# CI workflow for formatting, linting, type checking, and tests.
# Mirrors local ci_quick_check.ps1 and is intentionally simple for a single-developer prototype.

name: CI

# Trigger on pushes to main and on pull requests targeting main.
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Prevent duplicate runs for the same ref; cancel older runs when a new push happens.
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Single job that runs all checks sequentially.
  # This keeps the workflow simple and reuses the same environment and cache.
  checks:
    runs-on: ubuntu-latest

    # Stop the job if it runs longer than this (protects against hung jobs).
    timeout-minutes: 30

    # Show all failures in one run so you can see the full picture.
    strategy:
      fail-fast: false

    # Set CI environment variables so tools behave consistently in CI.
    env:
      CI: "true"

    steps:
      # 1) Checkout repository so we can run tests and linters against the code.
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Set up the Python runtime.
      # Using setup-python@v5 and Python 3.14 to match your current config.
      # Change python-version if you want to test other interpreters.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      # 3) Cache pip downloads to speed subsequent runs.
      # The cache key uses pyproject.toml and requirements files so it updates when deps change.
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml','**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4) Install project and development dependencies once.
      # Using editable install with dev extras ensures black, flake8, mypy, pytest are available.
      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      # 5) Run tests first (fast unit tests). Use importlib mode to avoid relative-import issues.
      - name: Run pytest
        run: pytest -q --import-mode=importlib

      # 6) Run static type checks with mypy.
      # --no-incremental forces a full check; remove if you prefer cached runs.
      - name: Run mypy
        run: mypy . --no-incremental

      # 7) Run flake8 linter for style and simple quality checks.
      - name: Run flake8
        run: flake8 .

      # 8) Run black in check mode to ensure formatting is consistent.
      # black --check returns non-zero if files would be reformatted.
      - name: Run black check
        run: black --check .